# ZaFrame — Анализ проекта и фазы работы по фронтенду

## 1. Анализ текущего состояния

### 1.1 Бэкенд (контекст для фронта)

- **Стек**: FastAPI, SQLAlchemy 2, Pydantic v2, uv
- **API**: версионированный `/api/v1/`
  - **auth** — Magic Link (request, verify, refresh)
  - **studios** — CRUD, публичный профиль студии
  - **services** — услуги студий, курсы, доступность
  - **slots** — слоты (расписание)
  - **bookings** — создание/отмена бронирований
  - **payments** — Stripe Checkout (single/course)
  - **webhooks** — Stripe webhooks

Домен: студии (фото/видео), услуги, слоты, бронирования, оплата, владельцы студий, гости (без аккаунта).

### 1.2 Фронтенд (что уже есть)

| Область | Состояние |
|--------|-----------|
| **Фреймворк** | Next.js 16 (App Router), React 19 |
| **Язык** | TypeScript |
| **Стили** | Tailwind CSS 4, кастомная тема в `globals.css` (mint/navy, polaroid) |
| **Данные** | TanStack React Query v5 |
| **Шрифты** | Inter, Montserrat (next/font) |
| **Страницы** | Главная, список/карточка студии, бронирование слота, список бронирований, confirm/cancel/success, dashboard владельца (студии CRUD), auth (login, verify) |
| **Компоненты** | Header, RequireAuth, UI-kit: Button, Card, Input, Textarea, Alert, Badge, Skeleton |
| **Типы** | auth, booking, payment, slot, studio, user (соответствуют бэкенду) |

### 1.3 Обнаруженные пробелы

- **Отсутствует папка `src/lib`**: в коде используются `@/lib/auth` (AuthProvider, useAuth) и `@/lib/api` (fetchStudio, createBooking, ApiError, requestMagicLink, verifyMagicLink и др.). Без этих модулей сборка/запуск фронта будут падать. Нужно добавить `lib/auth` и `lib/api` в первую фазу.

---

## 2. Технологии: что используем и что добавить

### 2.1 Уже выбранные (оставляем)

| Технология | Версия | Назначение |
|------------|--------|------------|
| **Next.js** | 16.x | App Router, RSC, API routes при необходимости |
| **React** | 19.x | UI |
| **TypeScript** | 5.x | Типизация |
| **Tailwind CSS** | 4.x | Стили, дизайн-система |
| **TanStack Query** | 5.x | Кэш, запросы, мутации |
| **React Compiler** | (babel) | Оптимизация рендеров (уже в devDependencies) |

### 2.2 Рекомендуемые добавления

| Технология | Назначение | Приоритет |
|------------|------------|-----------|
| **zod** | Валидация форм и ответов API на клиенте | Высокий |
| **React Hook Form** (опционально) | Формы с минимальными ре-рендерами, удобная интеграция с zod | Средний |
| **Единый API-клиент** | `src/lib/api` — один модуль с `baseURL`, обработкой 401/refresh, типами ошибок (ApiError) | Высокий |
| **Хранение токенов** | httpOnly cookie (если бэкенд отдаёт Set-Cookie) или безопасное хранение в памяти + refresh; не localStorage для access token в продакшене | Высокий |
| **Тестирование** | Vitest + React Testing Library для unit/интеграции компонентов и хуков | Средний |
| **E2E** | Playwright (по желанию) для критичных сценариев: студия → слот → бронь → оплата | Низкий |

### 2.3 Чего избегаем на текущем этапе

- Тяжёлых UI-библиотек (MUI, Ant) — уже есть свой UI-kit и дизайн-система.
- Redux/MobX — TanStack Query + контекст (Auth) достаточно для текущего объёма состояния.
- Отдельного state manager’а для форм — сначала React state + при необходимости React Hook Form.

### 2.4 Итог по технологиям

- **Ядро**: Next.js 16, React 19, TypeScript, Tailwind 4, TanStack Query.
- **Добавляем в первую очередь**: `src/lib/api`, `src/lib/auth`, валидация (zod), единый API-клиент с учётом CORS и cookie/токенов.
- **Далее по фазам**: React Hook Form (при росте форм), Vitest + RTL, при необходимости Playwright.

---

## 3. Фазы работы по фронтенду

### Фаза 0 — Основа (обязательно перед развитием фич)

**Цель**: проект собирается, авторизация и API работают.

- [ ] Добавить **`src/lib/api`**:
  - base URL из env (`NEXT_PUBLIC_API_URL`),
  - общий `fetch`/wrapper с подстановкой токена (из cookie или из auth context),
  - обработка 401 (refresh или редирект на login),
  - класс/тип **ApiError** с полем `body` для деталей с бэкенда,
  - функции под все используемые эндпоинты: studios, slots, bookings, auth (magic link request/verify), payments (по мере надобности).
- [ ] Добавить **`src/lib/auth`**:
  - **AuthProvider** (контекст): хранение user, access/refresh (или только флаг «залогинен» при cookie-based),
  - **useAuth**: доступ к user, login/logout, проверка авторизации.
- [ ] Проверить **.env.example** фронта: наличие `NEXT_PUBLIC_API_URL`.
- [ ] Убедиться, что логин (magic link) и verify доводят до залогиненного состояния и что защищённые страницы (dashboard, bookings) работают.

**Результат**: приложение запускается, можно залогиниться и ходить по студиям/бронированиям/dashboard.

---

### Фаза 1 — Стабильность и валидация

**Цель**: предсказуемые формы и типы, меньше runtime-ошибок.

- [ ] Ввести **zod** для:
  - схем ответов API (где нужно — парсинг после fetch),
  - схем форм (логин, бронирование, создание/редактирование студии).
- [ ] По желанию подключить **React Hook Form** + `@hookform/resolvers/zod` для страниц с формами (логин, бронь, студия).
- [ ] Унифицировать обработку ошибок API на страницах (использование ApiError и сообщений с бэкенда).
- [ ] Добавить базовые unit-тесты (Vitest + RTL) для критичных компонентов и для `lib/api`/`lib/auth` (моки fetch).

**Результат**: формы валидируются, ошибки обрабатываются единообразно, есть задел под тесты.

---

### Фаза 2 — UX и полировка публичных страниц

**Цель**: удобный и быстрый сценарий «выбор студии → слот → бронь».

- [ ] **Список студий**: фильтры (по городу/адресу, по типу услуги), сортировка, скелетоны, пустые состояния.
- [ ] **Карточка студии**: галерея фото (если бэкенд даёт ссылки), чёткое отображение услуг и цен, календарь/выбор даты для слотов.
- [ ] **Бронирование**: шаги (слот → данные гостя → подтверждение), проверка доступности слота перед отправкой, понятные сообщения при конфликте/ошибке.
- [ ] **Оплата**: после создания брони — переход в Stripe Checkout; после возврата с Stripe — страницы success/cancel с понятными сообщениями и ссылками «мои брони» / «на главную».
- [ ] Адаптивность и доступность (фокус, семантика, aria при необходимости).

**Результат**: публичный флоу от списка студий до оплаты понятен и устойчив.

---

### Фаза 3 — Личный кабинет и бронирования

**Цель**: пользователь и владелец видят нужную информацию и действия.

- [ ] **Мои бронирования**: список с фильтрами (активные/прошедшие/отменённые), отмена с подтверждением, переход к оплате если бронь ещё не оплачена.
- [ ] **Подтверждение брони** (`/bookings/[id]/confirm`): отображение деталей, кнопка «Оплатить» → Stripe, учёт уже оплаченных.
- [ ] **Dashboard владельца**: список студий, создание/редактирование студии, управление услугами и расписанием (если API готово), простые метрики (количество бронирований по студии).
- [ ] Уведомления/тосты при успешных действиях (создание студии, отмена брони и т.д.) — можно простой контекст + компонент Toast.

**Результат**: полный цикл для гостя и базовое управление для владельца.

---

### Фаза 4 — Расширения и масштаб

**Цель**: курсы, расписание, производительность.

- [ ] **Курсы**: отображение курсов студии, запись на курс, оплата курса (использовать существующие payment/order API).
- [ ] **Расписание**: календарное представление слотов (библиотека календаря по выбору), повторяющиеся слоты.
- [ ] Оптимизация: lazy loading страниц, оптимизация изображений (next/image), кэширование запросов (TanStack Query уже даёт базу).
- [ ] При необходимости — E2E (Playwright) для сценариев: гость бронирует и оплачивает; владелец создаёт студию.

**Результат**: поддержка курсов и расписания, быстрый и стабильный фронт.

---

## 4. Краткая сводка по технологиям

| Категория | Выбор |
|-----------|--------|
| Фреймворк | Next.js 16 (App Router) |
| UI | React 19, TypeScript |
| Стили | Tailwind CSS 4, текущая дизайн-система |
| Данные/кэш | TanStack Query |
| Авторизация | Контекст (AuthProvider) + lib/auth, токены/cookie |
| API | Единый слой в lib/api с ApiError и refresh |
| Валидация | zod (+ опционально React Hook Form) |
| Тесты | Vitest + React Testing Library; позже Playwright |

---

## 5. Следующий шаг

Начать с **Фазы 0**: реализовать `src/lib/api` и `src/lib/auth`, проверить переменные окружения и сценарий входа. После этого можно последовательно проходить Фазы 1–4.

Если нужно, могу расписать конкретную реализацию `lib/api` и `lib/auth` под твой бэкенд (формат токенов, cookie, refresh endpoint).
